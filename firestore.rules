rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userIdRule} {
      allow read, write: if request.auth != null && request.auth.uid == userIdRule;
    }

    match /households/{householdId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && (request.auth.uid in resource.data.members || resource.data.ownerId == request.auth.uid || (resource.data.pendingInvites != null && resource.data.pendingInvites.keys().size() > 0));
      allow list: if request.auth != null;
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;

      allow update: if request.auth != null && (
        // Condição 1: Proprietário pode fazer qualquer atualização.
        resource.data.ownerId == request.auth.uid ||

        // Condição 2: Usuário aceitando seu próprio convite
        (
          request.resource.data.members[request.auth.uid] != null &&
          !(request.auth.uid in resource.data.members) &&
          resource.data.pendingInvites != null &&
          resource.data.pendingInvites[request.auth.uid.replace(/\./g, '_')] != null &&
          request.resource.data.pendingInvites[request.auth.uid.replace(/\./g, '_')] == null &&
          request.resource.data.ownerId == resource.data.ownerId &&
          request.resource.data.name == resource.data.name
          // Adicione aqui outros campos que não devem ser alterados ao aceitar convite
          // Para maior segurança, verifique se outros campos não foram alterados:
          // Ex: resource.data.someOtherField == request.resource.data.someOtherField
        ) ||

        // Condição 3: Usuário não-proprietário saindo da família
        (
          request.auth.uid in resource.data.members &&
          resource.data.ownerId != request.auth.uid &&
          request.resource.data.members[request.auth.uid] == null &&
          resource.data.members[request.auth.uid] != null &&
          request.resource.data.members.keys().size() == resource.data.members.keys().size() - 1 &&
          request.resource.data.ownerId == resource.data.ownerId &&
          request.resource.data.name == resource.data.name &&
          ((resource.data.pendingInvites == null && request.resource.data.pendingInvites == null) ||
           (resource.data.pendingInvites != null && request.resource.data.pendingInvites != null &&
            resource.data.pendingInvites.keys().size() == request.resource.data.pendingInvites.keys().size()))
          // Adicione aqui outros campos que não devem ser alterados ao sair da família
        )
      );

      match /transactions/{transactionId} {
        allow read, write, create, delete: if request.auth != null && get(/databases/$(database)/documents/households/$(householdId)).data.members[request.auth.uid] != null;
      }

      match /investments/{investmentId} {
        allow read, write, create, delete: if request.auth != null && get(/databases/$(database)/documents/households/$(householdId)).data.members[request.auth.uid] != null;
        match /entries/{entryId} {
          allow read, write, create, delete: if request.auth != null && get(/databases/$(database)/documents/households/$(householdId)).data.members[request.auth.uid] != null;
        }
      }
    }
  }
}