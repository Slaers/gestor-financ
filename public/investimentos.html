<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investimentos - Gestão de Lançamentos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1 class="text-2xl font-bold p-4">Painel de Investimentos</h1> <!-- Changed Page Title -->
    <div id="investments-dashboard" class="p-4">
        <!-- Summary Cards Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Patrimônio Total Atual</h3>
                <p id="db-total-patrimonio" class="text-2xl font-semibold">R$ 0,00 <span id="db-total-patrimonio-loader" class="hidden text-sm ml-2 text-gray-400">(...)</span></p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Total Investido</h3>
                <p id="db-total-investido" class="text-2xl font-semibold">R$ 0,00 <span id="db-total-investido-loader" class="hidden text-sm ml-2 text-gray-400">(...)</span></p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Resultado Total (R$)</h3>
                <p id="db-resultado-reais" class="text-2xl font-semibold text-gray-700">R$ 0,00 <span id="db-resultado-reais-loader" class="hidden text-sm ml-2 text-gray-400">(...)</span></p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Resultado Total (%)</h3>
                <p id="db-resultado-percentual" class="text-2xl font-semibold text-gray-700">0,00% <span id="db-resultado-percentual-loader" class="hidden text-sm ml-2 text-gray-400">(...)</span></p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-xl font-semibold mb-2">Alocação da Carteira</h3>
                <canvas id="alocacaoCarteiraChart"></canvas>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-xl font-semibold mb-2">Desempenho da Carteira</h3>
                <div class="mb-2">
                    <button class="btn-period text-sm py-1 px-2 bg-gray-200 rounded hover:bg-gray-300">1M</button>
                    <button class="btn-period text-sm py-1 px-2 bg-gray-200 rounded hover:bg-gray-300">3M</button>
                    <button class="btn-period text-sm py-1 px-2 bg-gray-200 rounded hover:bg-gray-300">YTD</button>
                    <button class="btn-period text-sm py-1 px-2 bg-gray-200 rounded hover:bg-gray-300">1A</button>
                    <button class="btn-period text-sm py-1 px-2 bg-gray-200 rounded hover:bg-gray-300">MAX</button>
                </div>
                <canvas id="desempenhoCarteiraChart"></canvas>
            </div>
        </div>

        <!-- Ações Rápidas Section -->
        <div class="mb-6">
            <button id="btn-add-new-investment" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Adicionar Novo Investimento</button>
        </div>
    </div>
    <div id="investments-list" class="p-4 mt-6 border-t pt-6"> <!-- Added margin and border for separation -->
        <h2 class="text-xl font-semibold mb-4">Lista Detalhada de Investimentos</h2> <!-- Changed Section Title -->

        <!-- Toolbar/Controls Area -->
        <div class="mb-4 flex flex-wrap items-center gap-2 md:gap-4"> <!-- Adjusted gap for smaller screens -->
            <input type="search" id="search-investments" placeholder="Pesquisar por nome ou ticker..." class="p-2 border rounded w-full md:w-1/3 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            <select id="filter-type" class="p-2 border rounded shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="">Tipo de Investimento</option>
                <option value="Ação">Ação</option>
                <option value="FII">FII</option>
                <option value="ETF">ETF</option>
                <option value="Renda Fixa">Renda Fixa</option>
                <option value="Criptomoeda">Criptomoeda</option>
                <option value="Outros">Outros</option>
            </select>
            <select id="filter-status" class="p-2 border rounded shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="">Status</option>
                <option value="Ativo">Ativo</option>
                <option value="Vendido/Resgatado">Vendido/Resgatado</option>
                <option value="Vencido">Vencido</option>
            </select>
            <select id="filter-institution" class="p-2 border rounded shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="">Instituição</option>
                <!-- Options to be populated dynamically -->
                <option value="XP Investimentos">XP Investimentos</option>
                <option value="BTG Pactual">BTG Pactual</option>
                <option value="Binance">Binance</option>
            </select>
        </div>

        <!-- Table of Investments -->
        <div class="overflow-x-auto bg-white shadow rounded-lg">
            <table id="investments-table" class="min-w-full border">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-3 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nome do Investimento</th>
                        <th class="p-3 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ticker</th>
                        <th class="p-3 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                        <th class="p-3 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Instituição</th>
                        <th class="p-3 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Qtd.</th>
                        <th class="p-3 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Preço Méd. Aq.</th>
                        <th class="p-3 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Val. Investido</th>
                        <th class="p-3 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Preço Atual</th>
                        <th class="p-3 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Val. Total Atual</th>
                        <th class="p-3 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Resultado (R$)</th>
                        <th class="p-3 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Resultado (%)</th>
                        <th class="p-3 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">% Carteira</th>
                        <th class="p-3 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Vencimento</th>
                        <th class="p-3 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                        <th class="p-3 border-b text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody id="investments-table-body">
                    <tr id="investments-table-loading" class="text-center">
                        <td colspan="15" class="p-4 text-gray-500">Carregando investimentos...</td>
                    </tr>
                    <!-- Sample Row for Visualization -->
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-3 text-sm text-gray-700">Tesouro Selic 2029</td>
                        <td class="p-3 text-sm text-gray-700">TS2029</td>
                        <td class="p-3 text-sm text-gray-700">Tesouro Direto</td>
                        <td class="p-3 text-sm text-gray-700">XP Investimentos</td>
                        <td class="p-3 text-sm text-gray-700 text-right">2</td>
                        <td class="p-3 text-sm text-gray-700 text-right">R$ 13.800,00</td>
                        <td class="p-3 text-sm text-gray-700 text-right">R$ 27.600,00</td>
                        <td class="p-3 text-sm text-gray-700 text-right">R$ 14.000,00</td>
                        <td class="p-3 text-sm text-gray-700 text-right">R$ 28.000,00</td>
                        <td class="p-3 text-sm text-green-600 text-right">R$ 400,00</td>
                        <td class="p-3 text-sm text-green-600 text-right">1.45%</td>
                        <td class="p-3 text-sm text-gray-700 text-right">15.00%</td>
                        <td class="p-3 text-sm text-gray-700">01/01/2029</td>
                        <td class="p-3 text-sm text-gray-700"><span class="px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded-full">Ativo</span></td>
                        <td class="p-3 text-sm text-gray-700 text-center whitespace-nowrap">
                            <button class="text-blue-600 hover:text-blue-800 p-1" title="Ver Detalhes/Editar" aria-label="Ver Detalhes ou Editar Investimento">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7.172l2.586-2.586A2 2 0 0110 4.172l-2.586 2.586L5 9.172V12zM15 14H5a1 1 0 00-1 1v2a1 1 0 001 1h10a1 1 0 001-1v-2a1 1 0 00-1-1z"/></svg>
                            </button>
                            <button class="text-green-600 hover:text-green-800 p-1" title="Registrar Transação" aria-label="Registrar Nova Transação para este Investimento">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v4h4a1 1 0 110 2h-4v4a1 1 0 11-2 0v-4H5a1 1 0 110-2h4V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
                            </button>
                            <button class="text-red-600 hover:text-red-800 p-1" title="Excluir" aria-label="Excluir Investimento">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                            </button>
                        </td>
                    </tr>
                    <!-- More rows will be added here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="js/investment-logic.js"></script>
    <script src="js/household-investment-manager.js"></script>
    <script>
        // --- Household ID Logic ---
        let currentHouseholdId = null;

        function getHouseholdIdFromUrl() {
          const params = new URLSearchParams(window.location.search);
          return params.get('householdId');
        }

        function initializeHouseholdContext() {
          currentHouseholdId = getHouseholdIdFromUrl();
          if (currentHouseholdId) {
            console.log('Current Household ID:', currentHouseholdId);
          } else {
            console.warn('No householdId found in URL.');
          }
        }
        // --- End of Household ID Logic ---

        // --- Loading State & UI Update Functions ---
        function showLoading(elementId) {
            const el = document.getElementById(elementId);
            if (el) el.classList.remove('hidden');
        }
        function hideLoading(elementId) {
            const el = document.getElementById(elementId);
            if (el) el.classList.add('hidden');
        }

        async function loadAndDisplayInvestments() {
          if (!currentHouseholdId) {
            const loadingRow = document.getElementById('investments-table-loading');
            if(loadingRow) loadingRow.innerHTML = '<td colspan="15" class="p-4 text-red-500">ID da Família não especificado na URL.</td>';
            return;
          }

          const loadingRow = document.getElementById('investments-table-loading');
          if (loadingRow) loadingRow.classList.remove('hidden');


          try {
            const investments = await getHouseholdInvestments(currentHouseholdId);
            const tbody = document.getElementById('investments-table').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; // Clear existing rows

            if (investments.length === 0) {
              tbody.innerHTML = '<tr><td colspan="15" class="p-4 text-center text-gray-500">Nenhum investimento encontrado para esta família.</td></tr>';
              updateDashboardSummary([]);
              return;
            }

            const allInvestmentMetrics = [];

            for (const inv of investments) {
              const transactions = await getHouseholdInvestmentTransactions(currentHouseholdId, inv.id);
              const metrics = calculateInvestmentMetrics(transactions, inv.current_unit_price || '0');
              allInvestmentMetrics.push({...inv, metrics: metrics }); // Store inv data along with metrics for portfolio %

              const row = tbody.insertRow();
              row.setAttribute('data-id', inv.id);

              row.insertCell().textContent = inv.investment_name || '-';
              row.insertCell().textContent = inv.asset_ticker_symbol || '-';
              row.insertCell().textContent = inv.investment_type || '-';
              row.insertCell().textContent = inv.institution || '-';

              const qtyCell = row.insertCell();
              qtyCell.textContent = metrics.current_total_quantity !== undefined ? metrics.current_total_quantity.toFixed(2) : '-';
              qtyCell.classList.add('text-right');

              const wapCell = row.insertCell();
              wapCell.textContent = metrics.weighted_average_acquisition_price !== undefined ? `R$ ${metrics.weighted_average_acquisition_price.toFixed(2)}` : '-';
              wapCell.classList.add('text-right');

              const investedCell = row.insertCell();
              investedCell.textContent = metrics.cost_basis_current_holdings !== undefined ? `R$ ${metrics.cost_basis_current_holdings.toFixed(2)}` : '-';
              investedCell.classList.add('text-right');

              const currentPriceCell = row.insertCell();
              currentPriceCell.textContent = inv.current_unit_price ? `R$ ${parseFloat(inv.current_unit_price).toFixed(2)}` : '-';
              currentPriceCell.classList.add('text-right');

              const marketValueCell = row.insertCell();
              marketValueCell.textContent = metrics.market_value_current_holdings !== undefined ? `R$ ${metrics.market_value_current_holdings.toFixed(2)}` : '-';
              marketValueCell.classList.add('text-right');

              const profitLossAbsCell = row.insertCell();
              profitLossAbsCell.textContent = metrics.profit_loss_absolute !== undefined ? `R$ ${metrics.profit_loss_absolute.toFixed(2)}` : '-';
              profitLossAbsCell.classList.add('text-right');
              if (metrics.profit_loss_absolute > 0) profitLossAbsCell.classList.add('text-green-600');
              else if (metrics.profit_loss_absolute < 0) profitLossAbsCell.classList.add('text-red-600');

              const profitLossPercCell = row.insertCell();
              profitLossPercCell.textContent = metrics.profit_loss_percentage !== undefined ? `${metrics.profit_loss_percentage.toFixed(2)}%` : '-';
              profitLossPercCell.classList.add('text-right');
              if (metrics.profit_loss_percentage > 0) profitLossPercCell.classList.add('text-green-600');
              else if (metrics.profit_loss_percentage < 0) profitLossPercCell.classList.add('text-red-600');

              const portfolioPercCell = row.insertCell(); // % Portfolio
              portfolioPercCell.textContent = '-';
              portfolioPercCell.classList.add('text-right');

              row.insertCell().textContent = inv.maturity_date && inv.maturity_date.seconds ? new Date(inv.maturity_date.seconds * 1000).toLocaleDateString() : '-';

              const statusCell = row.insertCell();
              statusCell.innerHTML = `<span class="px-2 py-1 text-xs font-semibold text-gray-700 bg-gray-100 rounded-full">${inv.status || 'Ativo'}</span>`;
              if (inv.status === 'Ativo') statusCell.querySelector('span').classList.replace('text-gray-700','text-green-700');
              if (inv.status === 'Ativo') statusCell.querySelector('span').classList.replace('bg-gray-100','bg-green-100');


              const actionsCell = row.insertCell();
              actionsCell.classList.add('text-center', 'whitespace-nowrap');
              actionsCell.innerHTML = `
                <button onclick="openInvestmentDetailModal('${inv.id}')" class="text-blue-600 hover:text-blue-800 p-1" aria-label="Ver Detalhes ou Editar Investimento">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7.172l2.586-2.586A2 2 0 0110 4.172l-2.586 2.586L5 9.172V12zM15 14H5a1 1 0 00-1 1v2a1 1 0 001 1h10a1 1 0 001-1v-2a1 1 0 00-1-1z"/></svg>
                </button>
                <button onclick="openTransactionFormModal('${inv.id}')" class="text-green-600 hover:text-green-800 p-1" aria-label="Registrar Transação">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v4h4a1 1 0 110 2h-4v4a1 1 0 11-2 0v-4H5a1 1 0 110-2h4V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
                </button>
                <button onclick="handleDeleteInvestment('${inv.id}')" class="text-red-600 hover:text-red-800 p-1" aria-label="Excluir Investimento">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                </button>
              `;
            }
            updateDashboardSummary(allInvestmentMetrics.map(inv => inv.metrics)); // Pass only metrics array
            updatePortfolioPercentageColumn(allInvestmentMetrics); // Pass array of inv + metrics

          } catch (error) {
            console.error("Error loading investments: ", error);
            if(loadingRow) loadingRow.innerHTML = `<td colspan="15" class="p-4 text-red-500 text-center">Erro ao carregar investimentos: ${error.message}</td>`;
            updateDashboardSummary([]); // Clear dashboard on error
          } finally {
            if (loadingRow) loadingRow.classList.add('hidden');
          }
        }

        function updatePortfolioPercentageColumn(allInvestmentsWithMetrics) {
            const totalPortfolioValue = allInvestmentsWithMetrics.reduce((sum, inv) => sum + (inv.metrics.market_value_current_holdings || 0), 0);
            const tbody = document.getElementById('investments-table').getElementsByTagName('tbody')[0];

            let rowIndex = 0;
            for (const inv of allInvestmentsWithMetrics) {
                const row = tbody.rows[rowIndex];
                if (!row || !row.cells[11] || !inv.metrics) { // Check if row and cell exist
                    rowIndex++;
                    continue;
                }
                const marketValue = inv.metrics.market_value_current_holdings || 0;
                if (totalPortfolioValue > 0 && !isNaN(marketValue)) {
                    const percentage = (marketValue / totalPortfolioValue) * 100;
                    row.cells[11].textContent = percentage.toFixed(2) + '%';
                } else {
                    row.cells[11].textContent = '0.00%';
                }
                rowIndex++;
            }
        }

        function updateDashboardSummary(allInvestmentMetricsOnly) { // Expects array of metrics objects
          const portfolioSummary = calculatePortfolioSummary(allInvestmentMetricsOnly);

          const formatCurrency = (value) => value !== undefined ? `R$ ${value.toFixed(2)}` : 'R$ -';
          const formatPercentage = (value) => value !== undefined ? `${value.toFixed(2)}%` : '- %';

          document.getElementById('db-total-patrimonio').innerHTML = `${formatCurrency(portfolioSummary.current_total_portfolio_value)} <span id="db-total-patrimonio-loader" class="hidden text-sm ml-2 text-gray-400">(...)</span>`;
          document.getElementById('db-total-investido').innerHTML = `${formatCurrency(portfolioSummary.total_invested_portfolio_all_time)} <span id="db-total-investido-loader" class="hidden text-sm ml-2 text-gray-400">(...)</span>`;

          const resultadoReaisEl = document.getElementById('db-resultado-reais');
          resultadoReaisEl.innerHTML = `${formatCurrency(portfolioSummary.overall_portfolio_profit_loss_absolute)} <span id="db-resultado-reais-loader" class="hidden text-sm ml-2 text-gray-400">(...)</span>`;
          resultadoReaisEl.className = 'text-2xl font-semibold';
          if (portfolioSummary.overall_portfolio_profit_loss_absolute > 0) resultadoReaisEl.classList.add('text-green-600');
          else if (portfolioSummary.overall_portfolio_profit_loss_absolute < 0) resultadoReaisEl.classList.add('text-red-600');
          else resultadoReaisEl.classList.add('text-gray-700');

          const resultadoPercEl = document.getElementById('db-resultado-percentual');
          resultadoPercEl.innerHTML = `${formatPercentage(portfolioSummary.overall_portfolio_profit_loss_percentage)} <span id="db-resultado-percentual-loader" class="hidden text-sm ml-2 text-gray-400">(...)</span>`;
          resultadoPercEl.className = 'text-2xl font-semibold';
          if (portfolioSummary.overall_portfolio_profit_loss_percentage > 0) resultadoPercEl.classList.add('text-green-600');
          else if (portfolioSummary.overall_portfolio_profit_loss_percentage < 0) resultadoPercEl.classList.add('text-red-600');
          else resultadoPercEl.classList.add('text-gray-700');
        }

        // --- Form Modal & Submission ---
        const investmentForm = document.getElementById('investment-form');
        const investmentModal = document.getElementById('investment-form-modal'); // Already defined for toggle
        const addInvestmentBtn = document.getElementById('btn-add-new-investment'); // Already defined
        const closeBtn = document.getElementById('modal-close-btn'); // Already defined
        const cancelBtn = document.getElementById('modal-cancel-btn'); // Already defined
        const modalTitleEl = document.getElementById('form-modal-title-id'); // Changed from 'modal-title'


        addInvestmentBtn?.addEventListener('click', () => {
          modalTitleEl.textContent = 'Adicionar Novo Investimento';
          investmentForm.reset();
          document.getElementById('investment_id').value = ''; // Clear hidden ID field
          document.getElementById('rf-specific-fields').classList.add('hidden');
          document.getElementById('acoes-specific-fields').classList.add('hidden');
          document.getElementById('fundos-specific-fields').classList.add('hidden');
          document.getElementById('crypto-specific-fields').classList.add('hidden');
          investmentModal.classList.remove('hidden');
        });

        investmentForm.addEventListener('submit', async function(event) {
          event.preventDefault();
          if (!currentHouseholdId) {
            alert("ID da Família não encontrado. Não é possível salvar.");
            return;
          }
          const formData = new FormData(investmentForm);
          const data = Object.fromEntries(formData.entries());

          // Basic data processing
          data.total_quantity = parseFloat(data.initial_quantity) || 0;
          data.current_unit_price = parseFloat(data.initial_acquisition_price) || 0;
          if (data.initial_acquisition_date) {
            data.acquisition_date = firebase.firestore.Timestamp.fromDate(new Date(data.initial_acquisition_date));
          } else {
             data.acquisition_date = firebase.firestore.FieldValue.serverTimestamp(); // Default if not provided
          }

          const initialFees = parseFloat(formData.get('initial_fees_paid')) || 0;

          // Remove form-specific fields not part of the main investment schema before saving to 'investments'
          const coreInvestmentData = {...data};
          delete coreInvestmentData.initial_quantity;
          delete coreInvestmentData.initial_acquisition_price;
          delete coreInvestmentData.initial_acquisition_date;
          delete coreInvestmentData.initial_fees_paid;
          // Type-specific fields are assumed to be part of 'data' and will be saved if present
          // More sophisticated logic might be needed to clean them based on investment_type

          const investmentId = coreInvestmentData.investment_id;
          delete coreInvestmentData.investment_id;


          const formMessage = document.getElementById('form-message');
          try {
            formMessage.textContent = 'Salvando...';
            formMessage.className = 'mb-3 text-sm text-center text-blue-600';

            if (investmentId) {
              await updateHouseholdInvestment(currentHouseholdId, investmentId, coreInvestmentData);
              formMessage.textContent = 'Investimento atualizado com sucesso!';
            } else {
              const newInvestmentId = await addHouseholdInvestment(currentHouseholdId, coreInvestmentData);
              if (newInvestmentId && data.total_quantity > 0) {
                  const initialTransaction = {
                      transaction_type: 'Compra/Aporte',
                      transaction_date: data.acquisition_date,
                      quantity_transacted: data.total_quantity,
                      price_per_unit_transacted: data.current_unit_price,
                      fees_paid: initialFees
                  };
                  await addHouseholdInvestmentTransaction(currentHouseholdId, newInvestmentId, initialTransaction);
              }
              formMessage.textContent = 'Investimento adicionado com sucesso!';
            }
            formMessage.classList.replace('text-blue-600', 'text-green-600');
            investmentForm.reset();
            investmentModal.classList.add('hidden');
            loadAndDisplayInvestments();
          } catch (error) {
            console.error("Error saving investment: ", error);
            formMessage.textContent = `Erro ao salvar: ${error.message}`;
            formMessage.classList.replace('text-blue-600', 'text-red-600');
          }
        });

        // --- Detail Modal ---
        const investmentDetailModal = document.getElementById('investment-detail-modal'); // Already defined
        const detailCloseBtn = document.getElementById('detail-modal-close-btn'); // Already defined
        const detailModalTitleEl = document.getElementById('detail-modal-title-id'); // Changed from 'detail-modal-title'

        async function openInvestmentDetailModal(investmentId) {
          if (!currentHouseholdId || !investmentId) return;

          document.getElementById('detail-modal-title').textContent = 'Carregando Detalhes...';
          document.getElementById('investment-detail-content').innerHTML = '<p class="text-center p-4">Carregando...</p>';
          document.getElementById('transaction_log_body').innerHTML = '';
          investmentDetailModal.classList.remove('hidden');

          try {
            const investments = await getHouseholdInvestments(currentHouseholdId);
            const investment = investments.find(inv => inv.id === investmentId);

            if (!investment) throw new Error('Investimento não encontrado.');

            const transactions = await getHouseholdInvestmentTransactions(currentHouseholdId, investmentId);
            const metrics = calculateInvestmentMetrics(transactions, investment.current_unit_price || '0');

            detailModalTitleEl.textContent = `Detalhes: ${investment.investment_name}`;

            // Populate #investment-detail-content (General)
            document.getElementById('detail-investment_name').textContent = investment.investment_name || '-';
            document.getElementById('detail-asset_ticker_symbol').textContent = investment.asset_ticker_symbol || '-';
            document.getElementById('detail-investment_type').textContent = investment.investment_type || '-';
            document.getElementById('detail-investment_subtype').textContent = investment.investment_subtype || '-';
            document.getElementById('detail-institution').textContent = investment.institution || '-';
            document.getElementById('detail-account_identifier').textContent = investment.account_identifier || '-';
            document.getElementById('detail-currency').textContent = investment.currency || '-';
            document.getElementById('detail-status').textContent = investment.status || '-';
            document.getElementById('detail-risk_level').textContent = investment.risk_level || '-';
            document.getElementById('detail-objective').textContent = investment.objective || '-';
            document.getElementById('detail-notes').textContent = investment.notes || '-';

            // Populate #investment-detail-content (Values & Quantities)
            document.getElementById('detail-acquisition_date').textContent = investment.acquisition_date && investment.acquisition_date.seconds ? new Date(investment.acquisition_date.seconds * 1000).toLocaleDateString() : '-';
            document.getElementById('detail-total_quantity').textContent = metrics.current_total_quantity !== undefined ? metrics.current_total_quantity.toFixed(2) : '-';
            document.getElementById('detail-weighted_average_acquisition_price').textContent = metrics.weighted_average_acquisition_price !== undefined ? `R$ ${metrics.weighted_average_acquisition_price.toFixed(2)}` : '-';
            document.getElementById('detail-total_invested_amount').textContent = metrics.cost_basis_current_holdings !== undefined ? `R$ ${metrics.cost_basis_current_holdings.toFixed(2)}` : '-'; // Using cost_basis_current_holdings for "Total Investido Atual"
            document.getElementById('detail-current_unit_price').textContent = investment.current_unit_price ? `R$ ${parseFloat(investment.current_unit_price).toFixed(2)}` : '-';
            document.getElementById('detail-current_total_value').textContent = metrics.market_value_current_holdings !== undefined ? `R$ ${metrics.market_value_current_holdings.toFixed(2)}` : '-';
            document.getElementById('detail-profit_loss_absolute').textContent = metrics.profit_loss_absolute !== undefined ? `R$ ${metrics.profit_loss_absolute.toFixed(2)}` : '-';
            document.getElementById('detail-profit_loss_percentage').textContent = metrics.profit_loss_percentage !== undefined ? `${metrics.profit_loss_percentage.toFixed(2)}%` : '-';
            // % Portfolio will be filled by a separate function after all data is loaded for the main table

            // Show/hide and populate type-specific fields
            ['detail-rf-specific-fields', 'detail-acoes-specific-fields', 'detail-fundos-specific-fields', 'detail-crypto-specific-fields'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if (investment.investment_type === 'Tesouro Direto' || investment.investment_type === 'CDB' || investment.investment_type === 'LCI' || investment.investment_type === 'LCA' || investment.investment_type === 'Debênture' || investment.investment_type === 'Poupança') {
                document.getElementById('detail-rf-specific-fields').classList.remove('hidden');
                document.getElementById('detail-maturity_date').textContent = investment.maturity_date && investment.maturity_date.seconds ? new Date(investment.maturity_date.seconds * 1000).toLocaleDateString() : '-';
                document.getElementById('detail-interest_rate_type').textContent = investment.interest_rate_type || '-';
                document.getElementById('detail-contracted_rate_percentage').textContent = investment.contracted_rate_percentage ? `${investment.contracted_rate_percentage}%` : '-';
                document.getElementById('detail-indexer').textContent = investment.indexer || '-';
                document.getElementById('detail-taxation_type').textContent = investment.taxation_type || '-';
                document.getElementById('detail-is_fgc_covered').textContent = investment.is_fgc_covered ? 'Sim' : 'Não';
            } // Add else if for other types

            const transactionTbody = document.getElementById('transaction_log_body');
            transactionTbody.innerHTML = '';
            if (transactions.length > 0) {
              transactions.forEach(tx => {
                const row = transactionTbody.insertRow();
                row.insertCell().textContent = tx.transaction_date && tx.transaction_date.seconds ? new Date(tx.transaction_date.seconds * 1000).toLocaleDateString() : '-';
                row.insertCell().textContent = tx.transaction_type || '-';
                row.insertCell().textContent = tx.quantity_transacted !== undefined ? tx.quantity_transacted.toFixed(2) : '-';
                row.insertCell().textContent = tx.price_per_unit_transacted !== undefined ? `R$ ${parseFloat(tx.price_per_unit_transacted).toFixed(2)}` : '-';
                row.insertCell().textContent = (tx.quantity_transacted !== undefined && tx.price_per_unit_transacted !== undefined) ? `R$ ${(parseFloat(tx.quantity_transacted) * parseFloat(tx.price_per_unit_transacted)).toFixed(2)}` : '-';
                row.insertCell().textContent = tx.fees_paid !== undefined ? `R$ ${(parseFloat(tx.fees_paid) || 0).toFixed(2)}` : '-';
                const netAmount = (tx.quantity_transacted !== undefined && tx.price_per_unit_transacted !== undefined) ? (parseFloat(tx.quantity_transacted) * parseFloat(tx.price_per_unit_transacted)) - (parseFloat(tx.fees_paid) || 0) : 0;
                row.insertCell().textContent = `R$ ${netAmount.toFixed(2)}`;
              });
            } else {
              transactionTbody.innerHTML = '<tr><td colspan="7" class="p-2 text-center text-gray-500">Nenhuma transação registrada.</td></tr>';
            }
            investmentDetailModal.setAttribute('data-current-investment-id', investmentId);

          } catch (error) {
            console.error("Error opening investment detail: ", error);
            document.getElementById('investment-detail-content').innerHTML = `<p class="text-red-500 p-4 text-center">Erro ao carregar detalhes: ${error.message}</p>`;
          }
        }

        async function handleDeleteInvestment(investmentId) {
          if (!currentHouseholdId || !investmentId) return;
          if (confirm(`Tem certeza que deseja excluir este investimento e todas as suas transações? Esta ação não pode ser desfeita.`)) {
            try {
              const transactions = await getHouseholdInvestmentTransactions(currentHouseholdId, investmentId);
              for (const tx of transactions) {
                await deleteHouseholdInvestmentTransaction(currentHouseholdId, investmentId, tx.id);
              }
              await deleteHouseholdInvestment(currentHouseholdId, investmentId);
              alert('Investimento e suas transações foram excluídos com sucesso!');
              loadAndDisplayInvestments();
              investmentDetailModal.classList.add('hidden'); // Close detail modal if open
            } catch (error) {
              console.error("Error deleting investment: ", error);
              alert(`Erro ao excluir investimento: ${error.message}`);
            }
          }
        }

        function openTransactionFormModal(investmentId) {
            alert(`Funcionalidade "Adicionar Transação" para o investimento ID: ${investmentId} ainda não implementada.\nIsso abriria um formulário para adicionar uma nova transação a este investimento.`);
            // Implementation:
            // 1. Get a reference to a dedicated transaction form modal (needs to be created in HTML).
            // 2. Pre-fill the investmentId in that form.
            // 3. Display the transaction form modal.
            // 4. Handle its submission to call addHouseholdInvestmentTransaction().
        }

        // Initial Page Load
        window.addEventListener('DOMContentLoaded', () => {
          initializeHouseholdContext();
          if (currentHouseholdId) {
            loadAndDisplayInvestments();
          } else {
            const listBody = document.getElementById('investments-table-body'); // Corrected from getElementsByTagName
            if(listBody) listBody.innerHTML = '<tr><td colspan="15" class="p-4 text-center text-red-500">ID da Família não encontrado na URL. Verifique o link de acesso ou selecione uma família.</td></tr>';
            updateDashboardSummary([]);
          }

          // Event listeners for modals (already defined in previous steps, ensure they are here)
          // Form Modal
          closeBtn?.addEventListener('click', () => investmentModal.classList.add('hidden'));
          cancelBtn?.addEventListener('click', () => investmentModal.classList.add('hidden'));
          investmentModal?.addEventListener('click', (event) => {
            if (event.target === investmentModal) investmentModal.classList.add('hidden');
          });
          // Detail Modal
          detailCloseBtn?.addEventListener('click', () => investmentDetailModal.classList.add('hidden'));
          investmentDetailModal?.addEventListener('click', (event) => {
            if (event.target === investmentDetailModal) investmentDetailModal.classList.add('hidden');
          });
          // Escape key
          document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') closeAllModals();
          });
           // Dynamic fields for form modal
          investmentTypeSelect?.addEventListener('change', function() {
            const type = this.value;
            document.getElementById('rf-specific-fields').classList.add('hidden');
            document.getElementById('acoes-specific-fields').classList.add('hidden');
            document.getElementById('fundos-specific-fields').classList.add('hidden');
            document.getElementById('crypto-specific-fields').classList.add('hidden');

            if (type === 'Tesouro Direto' || type === 'CDB' || type === 'LCI' || type === 'LCA' || type === 'Debênture' || type === 'Poupança') {
                document.getElementById('rf-specific-fields').classList.remove('hidden');
            } else if (type === 'Ação') {
                document.getElementById('acoes-specific-fields').classList.remove('hidden');
            } else if (type === 'FII' || type === 'ETF' || type === 'Fundo de Investimento' || type === 'Previdência Privada') { // Added Previdência to Fundos
                document.getElementById('fundos-specific-fields').classList.remove('hidden');
            } else if (type === 'Moeda Digital') {
                document.getElementById('crypto-specific-fields').classList.remove('hidden');
            }
          });
           // Sample view button - This is conceptual if rows are dynamic.
           // Event delegation on tbody would be better for dynamic rows.
          const sampleViewButton = document.querySelector('#investments-table-body tr:not(#investments-table-loading) button[title="Ver Detalhes/Editar"]');
          sampleViewButton?.addEventListener('click', (event) => {
            openInvestmentDetailModal('sampleInvestmentId');
          });

        });

    </script>

    <!-- Investment Detail Modal -->
    <div id="investment-detail-modal" role="dialog" aria-modal="true" aria-labelledby="detail-modal-title-id" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white mb-10"> <!-- Adjusted top margin -->
        <!-- Modal Header -->
        <div class="flex justify-between items-center border-b pb-3 mb-4">
          <p id="detail-modal-title-id" class="text-2xl font-bold">Detalhes do Investimento</p> <!-- Added ID for aria-labelledby -->
          <button id="detail-modal-close-btn" class="cursor-pointer z-50" aria-label="Fechar modal de detalhes">
            <svg class="fill-current text-black hover:text-gray-700" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
          </button>
        </div>
        <!-- Modal Content -->
        <div id="investment-detail-content" class="text-sm">
          <h3 class="text-lg font-semibold mb-2 text-gray-700">Informações Gerais</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
            <div><span class="font-medium text-gray-500">Nome:</span> <span id="detail-investment_name" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Ticker:</span> <span id="detail-asset_ticker_symbol" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Tipo:</span> <span id="detail-investment_type" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Subtipo:</span> <span id="detail-investment_subtype" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Instituição:</span> <span id="detail-institution" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Conta:</span> <span id="detail-account_identifier" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Moeda:</span> <span id="detail-currency" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Status:</span> <span id="detail-status" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Nível de Risco:</span> <span id="detail-risk_level" class="text-gray-800">-</span></div>
          </div>
          <div class="mt-2"><span class="font-medium text-gray-500">Objetivo:</span> <span id="detail-objective" class="text-gray-800">-</span></div>
          <div class="mt-1"><span class="font-medium text-gray-500">Observações:</span> <span id="detail-notes" class="text-gray-800">-</span></div>

          <h3 class="text-lg font-semibold mb-2 mt-4 pt-2 border-t text-gray-700">Valores e Quantidades</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
            <div><span class="font-medium text-gray-500">Data Aquisição Inicial:</span> <span id="detail-acquisition_date" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Quantidade Total:</span> <span id="detail-total_quantity" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Preço Médio Aquisição:</span> <span id="detail-weighted_average_acquisition_price" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Total Investido:</span> <span id="detail-total_invested_amount" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Preço Unitário Atual:</span> <span id="detail-current_unit_price" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Valor Total Atual:</span> <span id="detail-current_total_value" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Resultado (R$):</span> <span id="detail-profit_loss_absolute" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">Resultado (%):</span> <span id="detail-profit_loss_percentage" class="text-gray-800">-</span></div>
            <div><span class="font-medium text-gray-500">% da Carteira:</span> <span id="detail-percentage_of_portfolio" class="text-gray-800">-</span></div>
          </div>

          <!-- Type-Specific Details Sections -->
          <div id="detail-rf-specific-fields" class="pt-3 mt-3 border-t hidden">
            <h4 class="text-md font-semibold mb-1 text-gray-600">Detalhes de Renda Fixa</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1">
              <div><span class="font-medium text-gray-500">Data de Vencimento:</span> <span id="detail-maturity_date" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">Tipo de Rentabilidade:</span> <span id="detail-interest_rate_type" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">Taxa Contratada (%):</span> <span id="detail-contracted_rate_percentage" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">Indexador:</span> <span id="detail-indexer" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">Tributação:</span> <span id="detail-taxation_type" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">Coberto pelo FGC:</span> <span id="detail-is_fgc_covered" class="text-gray-800">-</span></div>
            </div>
          </div>

          <div id="detail-acoes-specific-fields" class="pt-3 mt-3 border-t hidden">
            <h4 class="text-md font-semibold mb-1 text-gray-600">Detalhes de Ações</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1">
              <div><span class="font-medium text-gray-500">Bolsa:</span> <span id="detail-stock_exchange" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">Setor:</span> <span id="detail-sector" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">CNPJ Empresa:</span> <span id="detail-cnpj_acao" class="text-gray-800">-</span></div>
            </div>
          </div>

          <div id="detail-fundos-specific-fields" class="pt-3 mt-3 border-t hidden">
            <h4 class="text-md font-semibold mb-1 text-gray-600">Detalhes de Fundos/Previdência</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1">
              <div><span class="font-medium text-gray-500">CNPJ Fundo:</span> <span id="detail-fund_cnpj" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">Taxa Adm.(%):</span> <span id="detail-administrator_fee_percentage" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">Taxa Perf.(%):</span> <span id="detail-performance_fee_percentage" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">Benchmark:</span> <span id="detail-benchmark" class="text-gray-800">-</span></div>
            </div>
          </div>

          <div id="detail-crypto-specific-fields" class="pt-3 mt-3 border-t hidden">
            <h4 class="text-md font-semibold mb-1 text-gray-600">Detalhes de Moedas Digitais</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1">
              <div><span class="font-medium text-gray-500">Código Ativo:</span> <span id="detail-crypto_asset_code" class="text-gray-800">-</span></div>
              <div><span class="font-medium text-gray-500">Exchange/Carteira:</span> <span id="detail-exchange_platform_wallet" class="text-gray-800">-</span></div>
            </div>
          </div>
        </div>
        <!-- Transaction Log -->
        <div class="mt-6">
          <h3 class="text-xl font-semibold mb-2">Histórico de Transações</h3>
          <div class="overflow-x-auto max-h-60"> <!-- Added max-h-60 for scrollable transaction log -->
            <table id="transaction_log_table" class="min-w-full bg-white border">
              <thead class="sticky top-0 bg-gray-100 z-10"> <!-- Made header sticky -->
                <tr class="bg-gray-50">
                  <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Data</th>
                  <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                  <th class="p-2 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Qtd.</th>
                  <th class="p-2 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Preço Unit.</th>
                  <th class="p-2 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Total</th>
                  <th class="p-2 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Taxas</th>
                  <th class="p-2 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Líquido</th>
                </tr>
              </thead>
              <tbody id="transaction_log_body" class="text-sm">
                <!-- Sample Transaction Row (will be replaced by JS) -->
                <tr>
                  <td class="p-2 border-b">2023-03-20</td>
                  <td class="p-2 border-b">Compra/Aporte</td>
                  <td class="p-2 border-b text-right">50</td>
                  <td class="p-2 border-b text-right">R$ 26,00</td>
                  <td class="p-2 border-b text-right">R$ 1300,00</td>
                  <td class="p-2 border-b text-right">R$ 4,90</td>
                  <td class="p-2 border-b text-right">R$ 1295,10</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- Modal Actions -->
        <div class="flex justify-end pt-6 border-t mt-6">
          <button id="detail-edit-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 mr-2 shadow-sm">Editar Investimento</button>
          <button id="detail-add-transaction-btn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 mr-2 shadow-sm">Registrar Transação</button>
          <button id="detail-delete-btn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 shadow-sm">Excluir Investimento</button>
        </div>
      </div>
    </div>

    <!-- Investment Form Modal -->
    <div id="investment-form-modal" role="dialog" aria-modal="true" aria-labelledby="form-modal-title-id" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-10 mx-auto p-6 border w-full max-w-3xl shadow-lg rounded-md bg-white mb-10"> <!-- Adjusted top margin -->
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-3 mb-4 border-b">
          <p id="form-modal-title-id" class="text-2xl font-bold">Adicionar Novo Investimento</p> <!-- Added ID for aria-labelledby -->
          <button id="modal-close-btn" class="modal-close cursor-pointer z-50" aria-label="Fechar modal de formulário">
            <svg class="fill-current text-black hover:text-gray-700" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
          </button>
        </div>
        <!-- Modal Content (Form) -->
        <form id="investment-form">
          <input type="hidden" id="investment_id" name="investment_id"> <!-- For editing -->
          <div id="form-message" class="mb-3 text-sm text-center"></div> <!-- Form message placeholder -->

          <h3 class="text-lg font-semibold mb-3 text-gray-700">Informações Gerais</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div class="mb-4">
              <label for="investment_name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Investimento <span class="text-red-500">*</span></label>
              <input type="text" name="investment_name" id="investment_name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
            </div>
            <div class="mb-4">
              <label for="asset_ticker_symbol" class="block text-sm font-medium text-gray-700 mb-1">Ticker / Símbolo</label>
              <input type="text" name="asset_ticker_symbol" id="asset_ticker_symbol" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div class="mb-4">
              <label for="investment_type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Investimento <span class="text-red-500">*</span></label>
              <select name="investment_type" id="investment_type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                <option value="">Selecione o Tipo</option>
                <option value="Poupança">Poupança</option>
                <option value="Tesouro Direto">Tesouro Direto</option>
                <option value="CDB">CDB</option>
                <option value="LCI">LCI</option>
                <option value="LCA">LCA</option>
                <option value="Debênture">Debênture</option>
                <option value="Ação">Ação</option>
                <option value="FII">FII</option>
                <option value="ETF">ETF</option>
                <option value="Fundo de Investimento">Fundo de Investimento</option>
                <option value="Previdência Privada">Previdência Privada</option>
                <option value="Moeda Digital">Moeda Digital</option>
                <option value="Outro">Outro</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="investment_subtype" class="block text-sm font-medium text-gray-700 mb-1">Subtipo (Opcional)</label>
              <input type="text" name="investment_subtype" id="investment_subtype" placeholder="Ex: Tesouro Selic 2029, Apple Inc." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div class="mb-4">
              <label for="institution" class="block text-sm font-medium text-gray-700 mb-1">Instituição Financeira / Corretora <span class="text-red-500">*</span></label>
              <input type="text" name="institution" id="institution" placeholder="Ex: XP, BTG, Binance" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
            </div>
            <div class="mb-4">
              <label for="account_identifier" class="block text-sm font-medium text-gray-700 mb-1">Número da Conta / Identificador (Opcional)</label>
              <input type="text" name="account_identifier" id="account_identifier" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
             <div class="mb-4">
              <label for="currency" class="block text-sm font-medium text-gray-700 mb-1">Moeda <span class="text-red-500">*</span></label>
              <select name="currency" id="currency" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                <option value="BRL">BRL (Real Brasileiro)</option>
                <option value="USD">USD (Dólar Americano)</option>
                <option value="EUR">EUR (Euro)</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status <span class="text-red-500">*</span></label>
              <select name="status" id="status" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                <option value="Ativo">Ativo</option>
                <option value="Vendido/Resgatado">Vendido/Resgatado</option>
                <option value="Vencido">Vencido</option>
              </select>
            </div>
             <div class="mb-4">
                <label for="risk_level" class="block text-sm font-medium text-gray-700 mb-1">Nível de Risco (Opcional)</label>
                <select name="risk_level" id="risk_level" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">Selecione</option>
                    <option value="Baixo">Baixo</option>
                    <option value="Médio">Médio</option>
                    <option value="Alto">Alto</option>
                </select>
            </div>
            <div class="mb-4 md:col-span-2">
                <label for="objective" class="block text-sm font-medium text-gray-700 mb-1">Objetivo / Estratégia (Opcional)</label>
                <textarea name="objective" id="objective" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
            </div>
            <div class="mb-4 md:col-span-2">
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Observações (Opcional)</label>
                <textarea name="notes" id="notes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
            </div>
          </div>

          <h3 class="text-lg font-semibold mb-3 mt-4 pt-4 border-t text-gray-700">Detalhes da Quantidade e Valor (Inicial)</h3>
          <p class="text-xs text-gray-500 mb-3">Para o primeiro registro do investimento. Transações subsequentes (compras, vendas, proventos) são adicionadas separadamente.</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div class="mb-4">
              <label for="initial_acquisition_date" class="block text-sm font-medium text-gray-700 mb-1">Data da Aquisição Inicial <span class="text-red-500">*</span></label>
              <input type="date" name="initial_acquisition_date" id="initial_acquisition_date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
            </div>
            <div class="mb-4">
              <label for="initial_quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Inicial <span class="text-red-500">*</span></label>
              <input type="number" step="any" name="initial_quantity" id="initial_quantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
            </div>
            <div class="mb-4">
              <label for="initial_acquisition_price" class="block text-sm font-medium text-gray-700 mb-1">Preço de Aquisição Unitário Inicial <span class="text-red-500">*</span></label>
              <input type="number" step="any" name="initial_acquisition_price" id="initial_acquisition_price" placeholder="Preço por unidade/cota" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
            </div>
            <div class="mb-4">
              <label for="initial_fees_paid" class="block text-sm font-medium text-gray-700 mb-1">Taxas Pagas na Aquisição Inicial (Opcional)</label>
              <input type="number" step="any" name="initial_fees_paid" id="initial_fees_paid" placeholder="Total de taxas" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
          </div>

          <!-- Detalhes Específicos do Tipo (Dynamically Shown) -->
          <div id="type-specific-fields-container" class="mt-4 pt-4 border-t">
            <h3 class="text-lg font-semibold mb-1 text-gray-700">Detalhes Específicos do Tipo</h3>
            <p class="text-xs text-gray-500 mb-3">Campos adicionais baseados no tipo de investimento selecionado.</p>

            <div id="rf-specific-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-x-6">
              <h4 class="md:col-span-2 text-md font-medium mb-2 text-gray-600">Renda Fixa / Poupança</h4>
              <div class="mb-4">
                <label for="maturity_date" class="block text-sm font-medium text-gray-700 mb-1">Data de Vencimento (Opcional)</label>
                <input type="date" name="maturity_date" id="maturity_date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
              <div class="mb-4">
                <label for="interest_rate_type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Rentabilidade (Opcional)</label>
                <select name="interest_rate_type" id="interest_rate_type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">Selecione</option>
                    <option value="Pré-fixado">Pré-fixado</option>
                    <option value="Pós-fixado Indexador">Pós-fixado (Indexador)</option>
                    <option value="Pós-fixado Indexador + Spread">Pós-fixado (Indexador + Spread)</option>
                    <option value="Híbrido">Híbrido (Inflação + Taxa)</option>
                </select>
              </div>
              <div class="mb-4">
                <label for="contracted_rate_percentage" class="block text-sm font-medium text-gray-700 mb-1">Taxa Contratada (%) (Opcional)</label>
                <input type="number" step="any" name="contracted_rate_percentage" id="contracted_rate_percentage" placeholder="Ex: 10.5 para 10.5%" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
               <div class="mb-4">
                <label for="indexer" class="block text-sm font-medium text-gray-700 mb-1">Indexador (Opcional)</label>
                <input type="text" name="indexer" id="indexer" placeholder="Ex: CDI, IPCA, Selic" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
              <div class="mb-4">
                <label for="taxation_type" class="block text-sm font-medium text-gray-700 mb-1">Tributação (Opcional)</label>
                <select name="taxation_type" id="taxation_type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">Selecione</option>
                    <option value="Regressiva">IR Regressivo</option>
                    <option value="Isento">Isento de IR</option>
                    <option value="Outra">Outra</option>
                </select>
              </div>
              <div class="mb-4 flex items-center">
                <input type="checkbox" name="is_fgc_covered" id="is_fgc_covered" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="is_fgc_covered" class="ml-2 block text-sm text-gray-900">Coberto pelo FGC? (Opcional)</label>
              </div>
            </div>

            <div id="acoes-specific-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-x-6">
              <h4 class="md:col-span-2 text-md font-medium mb-2 text-gray-600">Ações</h4>
              <div class="mb-4">
                <label for="stock_exchange" class="block text-sm font-medium text-gray-700 mb-1">Bolsa de Valores (Opcional)</label>
                <input type="text" name="stock_exchange" id="stock_exchange" placeholder="Ex: B3, NASDAQ" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
              <div class="mb-4">
                <label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Setor (Opcional)</label>
                <input type="text" name="sector" id="sector" placeholder="Ex: Tecnologia, Varejo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
              <div class="mb-4">
                <label for="cnpj_acao" class="block text-sm font-medium text-gray-700 mb-1">CNPJ da Empresa (Opcional)</label>
                <input type="text" name="cnpj_acao" id="cnpj_acao" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
            </div>

            <div id="fundos-specific-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-x-6">
              <h4 class="md:col-span-2 text-md font-medium mb-2 text-gray-600">Fundos (FII, ETF, FI) / Previdência</h4>
              <div class="mb-4">
                <label for="fund_cnpj" class="block text-sm font-medium text-gray-700 mb-1">CNPJ do Fundo (Opcional)</label>
                <input type="text" name="fund_cnpj" id="fund_cnpj" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
              <div class="mb-4">
                <label for="administrator_fee_percentage" class="block text-sm font-medium text-gray-700 mb-1">Taxa de Administração (%) (Opcional)</label>
                <input type="number" step="any" name="administrator_fee_percentage" id="administrator_fee_percentage" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
              <div class="mb-4">
                <label for="performance_fee_percentage" class="block text-sm font-medium text-gray-700 mb-1">Taxa de Performance (%) (Opcional)</label>
                <input type="text" name="performance_fee_percentage" id="performance_fee_percentage" placeholder="Ex: 20% sobre o que exceder o CDI" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
              <div class="mb-4">
                <label for="benchmark" class="block text-sm font-medium text-gray-700 mb-1">Benchmark (Opcional)</label>
                <input type="text" name="benchmark" id="benchmark" placeholder="Ex: IBOVESPA, CDI" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              </div>
            </div>

            <div id="crypto-specific-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-x-6">
                <h4 class="md:col-span-2 text-md font-medium mb-2 text-gray-600">Moedas Digitais</h4>
                <div class="mb-4">
                    <label for="crypto_asset_code" class="block text-sm font-medium text-gray-700 mb-1">Código do Ativo Digital (Opcional)</label>
                    <input type="text" name="crypto_asset_code" id="crypto_asset_code" placeholder="Ex: BTC, ETH, ADA" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="exchange_platform_wallet" class="block text-sm font-medium text-gray-700 mb-1">Exchange / Plataforma / Carteira (Opcional)</label>
                    <input type="text" name="exchange_platform_wallet" id="exchange_platform_wallet" placeholder="Ex: Binance, Ledger Nano S" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex justify-end pt-6 mt-6 border-t">
            <button type="button" id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 mr-3 shadow-sm">Cancelar</button>
            <button type="submit" id="modal-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 shadow-sm">Salvar Investimento</button>
          </div>
        </form>
      </div>
    </div>
</body>
</html>
